<?php

/**
 * Created by PhpStorm.
 * User: user
 * Date: 19.11.2017
 * Time: 18:30
 */
class CallbackController extends BaseController
{
    /** @var $admin BotEntity  */
    private $bot   = null;

    public function init()
    {
        $this->bot = new BotEntity();
        parent::init(); // TODO: Change the autogenerated stub
    }

    /**
     * @return null
     */
    public function actionVk()
    {
        $data = json_decode(file_get_contents('php://input'));

        if ($data->type == 'board_post_new'
            && $data->secret == Globals::$config->group_secret
            && $data->object->from_id != ('-' . Globals::$config->group_id)
        ) {
            $userModel = new UserModel();
            $userEntity = $userModel->findBySocialId($data->object->from_id);
            $model = new ActionModel();
            $data = $model->getScores($userEntity->id);

            $likeScores = isset($data['like']) ? $data['like'] : 0;
            $tenLikeScores = isset($data['ten_like']) ? $data['ten_like'] : 0;
            $firstLikeScores = isset($data['first_like']) ? $data['first_like'] : 0;
            $commentScores = isset($data['comment']) ? $data['comment'] : 0;
            $repostScores = isset($data['repost']) ? $data['repost'] : 0;

            if ($userEntity->is_member && $userEntity->is_repost) {
                $message = "[id$userEntity->social_id|$userEntity->name], ваши очки:\n"
                    . " - за лайки постов - $likeScores\n"
                    . " - за лайки в числе первых - $tenLikeScores\n"
                    . " - за первый лайк - $firstLikeScores\n"
                    . " - за коментарии постов - $commentScores\n"
                    . " - за репосты - $repostScores\n";
            } elseif ($userEntity->is_member && !$userEntity->is_repost) {
                $message = "У Вас не сделан репост записи о конкурсе. Это последний шаг:)";
            } else {
                $message = "Вы не являетесь участником сообщества. Данные по количествам баллов недоступны. Сначала вступите :)";
            }
            VkSdk::addComment(Globals::$config->standalone_token, $message);

            echo 'ok';
            exit();
        } else {
            echo Globals::$config->group_confirm;
            exit();
        }
    }
}